{% extends "fd/layout.html" %}
{% load static %}

{% block title %}–ú–µ–Ω—é | FoodDV –ë—Ä–µ—Å—Ç{% endblock %}

{% block content %}
{% csrf_token %}
<input type="hidden" id="csrf_token" value="{{ csrf_token }}">

<div class="container mt-4">
    <h1 class="mb-4">üçî –ú–µ–Ω—é —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤ –ë—Ä–µ—Å—Ç–∞</h1>

    <!-- –§–∏–ª—å—Ç—Ä—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–π -->
    <div class="btn-group mb-4 flex-wrap" id="category-filters">
        <button class="btn btn-outline-primary active" data-category="all">
            <i class="bi bi-list-ul me-1"></i> –í—Å–µ
        </button>
        {% for cat_id, cat in categories.items %}
        <button class="btn btn-outline-primary" data-category="{{ cat_id }}">
            <i class="bi {{ cat.icon }} me-1"></i> {{ cat.name }}
        </button>
        {% endfor %}
    </div>

    <div class="row g-4" id="product-grid">
        {% for product in products %}
        <div class="col-lg-3 col-md-4 col-6 product-card" data-category="{{ product.category }}">
            <div class="card h-100 shadow-sm">
                {% if product.image %}
                {% static 'fd/img/default-food.jpg' as default_food %}
                    <img src="{{ product.image }}" 
                        class="card-img-top product-image"
                        alt="{{ product.name }}"
                        onerror="this.src='{{ default_food }}'">
                {% else %}
                <img src="{% static 'fd/img/default-food.jpg' %}" 
                     class="card-img-top product-image"
                     alt="{{ product.name }}">
                {% endif %}
                <div class="card-body">
                    <h5 class="card-title">{{ product.name }}</h5>
                    <p class="card-text text-muted small">{{ product.description }}</p>
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <span class="fw-bold text-primary">{{ product.price }} BYN</span>
                        <button class="btn btn-primary btn-sm add-to-cart" 
                                data-product-id="{{ product.id }}">
                            <i class="bi bi-cart-plus"></i> –í –∫–æ—Ä–∑–∏–Ω—É
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12">
            <div class="alert alert-warning text-center py-4">
                <i class="bi bi-exclamation-circle fs-4"></i>
                <p class="mb-0 mt-2">–¢–æ–≤–∞—Ä—ã –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç</p>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function getCSRFToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
}

// –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
function setupCategoryFilters() {
    const filterButtons = document.querySelectorAll('#category-filters button');
    
    filterButtons.forEach(button => {
        button.addEventListener('click', function() {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
            filterButtons.forEach(btn => {
                btn.classList.remove('active', 'fw-bold');
                btn.querySelector('i').classList.remove('text-white');
            });
            this.classList.add('active', 'fw-bold');
            this.querySelector('i').classList.add('text-white');
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä
            const category = this.dataset.category;
            const products = document.querySelectorAll('.product-card');
            
            products.forEach(product => {
                const matches = category === 'all' || product.dataset.category === category;
                product.style.display = matches ? 'block' : 'none';
            });
        });
    });
}

// –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–∞
function dispatchCartUpdate() {
    document.dispatchEvent(new CustomEvent('cartUpdated'));
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∫–æ—Ä–∑–∏–Ω—É —Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º —Å—á–µ—Ç—á–∏–∫–∞
async function addToCart(productId) {
    const button = document.querySelector(`.add-to-cart[data-product-id="${productId}"]`);
    if (!button) return;
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    const originalHtml = button.innerHTML;
    const originalClass = button.className;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏
    button.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
    button.className = originalClass + ' disabled';
    
    try {
        const response = await fetch(`{% url 'add_to_cart' 0 %}`.replace('0', productId), {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) {
            throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
        }

        const data = await response.json();
        if (!data.success) {
            throw new Error(data.error || '–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è');
        }

        button.innerHTML = '<i class="bi bi-check2"></i> –î–æ–±–∞–≤–ª–µ–Ω–æ';
        button.className = originalClass.replace('btn-primary', 'btn-success');
        
        dispatchCartUpdate();
        
        setTimeout(() => {
            button.innerHTML = originalHtml;
            button.className = originalClass;
        }, 2000);

    } catch (error) {
        console.error('–û—à–∏–±–∫–∞:', error);
        
        button.innerHTML = '<i class="bi bi-x-circle"></i> –û—à–∏–±–∫–∞';
        button.className = originalClass.replace('btn-primary', 'btn-danger');
        
        setTimeout(() => {
            button.innerHTML = originalHtml;
            button.className = originalClass;
        }, 2000);
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
document.addEventListener('DOMContentLoaded', function() {
    setupCategoryFilters();
    
    document.querySelectorAll('.add-to-cart').forEach(button => {
        button.addEventListener('click', function() {
            const productId = this.dataset.productId;
            addToCart(productId);
        });
    });
});
</script>

<style>
    .product-card {
        transition: all 0.3s ease;
    }
    
    .product-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    
    #category-filters .active {
        background-color: var(--bs-primary);
        color: white !important;
    }
    
    .product-image {
        height: 180px;
        object-fit: cover;
        transition: transform 0.3s ease;
    }
    
    .product-card:hover .product-image {
        transform: scale(1.03);
    }
    
    .add-to-cart {
        transition: all 0.2s ease;
    }
</style>
{% endblock %}
